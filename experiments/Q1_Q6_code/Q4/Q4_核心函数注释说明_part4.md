# Q4: 长上下文位置漂移分析 - 核心函数注释说明 (Part 4)

## 文件对齐
- **对应脚本**: `q4_analyze_q4_long_context.py`
- **行号说明**: 以当前脚本为准，本文行号仅作理解辅助

---

## 7. 曲线重采样与置信区间

这一部分解决一个“真实数据里经常遇到的问题”：  
不同样本的长度不一样，所以每个样本的窗口数量也不一样。  
如果不做处理，短样本只有几段、长样本有很多段，就没法在同一横轴上求平均曲线。

### 函数: `resample_curve()`  
**位置**: 第213行附近  

**作用**:  
把不同长度的曲线统一映射为“固定长度”的曲线（默认 20 个点），  
这样就可以把不同样本的曲线对齐后求均值。  

**核心思想**:  
1. 把原曲线的横坐标归一化到 [0, 1]  
2. 在 [0, 1] 上取固定数量的新点  
3. 用线性插值补齐缺失点  

**代码逻辑**（对应脚本中的实现）:
```python
x_old = np.linspace(0.0, 1.0, num=len(curve))
x_new = np.linspace(0.0, 1.0, num=target_len)
y_new = np.interp(x_new, x_old, np.array(curve))
```

**直观理解**:  
把“长曲线”和“短曲线”都拉伸成相同长度，  
这样“序列前 10% / 中间 50% / 后 10%”都能对应上。

---

### 函数: `mean_ci()`  
**位置**: 第229行附近  

**作用**:  
对多条曲线求均值，并计算 95% 置信区间（CI）。  
用于在图里显示“均值曲线 + 置信区间阴影”。  

**公式对应**:  
```
SEM = std / sqrt(n)
CI = 1.96 * SEM
```

**解释**:  
- SEM（标准误）表示“均值的不确定性”  
- 1.96 对应正态分布 95% 区间  
- CI 越小，说明多次样本曲线越稳定  

**代码逻辑**:
```python
mean = np.mean(arr, axis=0)
sem = np.std(arr, axis=0, ddof=1) / sqrt(n)
ci = 1.96 * sem
```

---

## 为什么这一段很重要

如果没有重采样和置信区间：  
1. 不同样本长度不一致 → 平均曲线不可比  
2. 没有误差带 → 无法判断漂移是否“稳定存在”  

加入这两步后，Q4 的图才有了“可解释性”和“可信度”。
