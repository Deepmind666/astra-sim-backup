# Q5: 路由置信度特征分析 - 核心函数注释说明

## 文件信息
- **对应脚本**: `q5_analyze_q5_full.py`（主分析）+ `q5_analyze_q5_confidence.py`（置信度分层/细化）+ `q5_plot_q5_figures.py`（画图）
- **行号说明**: 以当前脚本为准，本文行号仅作理解辅助
- **核心问题**: 分析 MoE 路由的置信度特征,探究专家选择的确定性

## 核心问题

### 问题描述
Q5 关注的是**路由置信度**(Routing Confidence):
- **置信度定义**: Top-1 专家的概率值
- **核心问题**: 路由置信度是否反映了模型对专家选择的确定性?

### 5个证据维度
1. **证据1**: 任务间置信度对比 - 不同任务的置信度是否有差异?
2. **证据2**: 多层置信度一致性 - 多层是否倾向选择相同专家?
3. **证据3**: 置信度 vs 切换率关联 - 高置信度是否对应低切换率?
4. **证据4**: 序列位置 vs 置信度 - 置信度是否随位置变化?
5. **证据5**: 低置信度 token 特征 - 低置信度 token 有何特点?

---

## 核心概念

### 1. 置信度 (Confidence)
**定义**: Top-1 专家的概率值

**公式**:
```
Confidence = max(P(e|token))
```

**含义**:
- 高置信度(如 0.9) → 模型对专家选择很确定
- 低置信度(如 0.3) → 模型对专家选择不确定

### 2. 归一化熵 (Normalized Entropy)
**定义**: 分布熵除以最大熵

**公式**:
```
H_norm = H(P) / log2(K)
其中 H(P) = -Σ P * log2(P)
```

**含义**:
- H_norm ≈ 0 → 分布集中(高置信度)
- H_norm ≈ 1 → 分布均匀(低置信度)

### 3. 多层一致性 (Multi-Layer Consistency)
**定义**: 多层选择相同 Top-1 专家的比例

**公式**:
```
Consistency = Σ 1[所有层的Top1相同] / N
```

---

## 核心函数详解

### 1. 数学工具函数

#### 函数: `entropy()`
**位置**: 第43-47行

**定义**: 计算分布熵

**公式**: H(P) = -Σ P * log2(P)

---

#### 函数: `normalized_entropy()`
**位置**: 第50-57行

**定义**: 计算归一化熵

**算法**:
```python
def normalized_entropy(p: np.ndarray):
    k = len(p)
    if k <= 1:
        return 0.0
    h = entropy(p)
    max_h = math.log2(k)
    return h / max_h
```

---

#### 函数: `ks_test()`
**位置**: 第60-66行

**目的**: Kolmogorov-Smirnov 检验,比较两组数据的分布

**返回**: {"statistic": KS统计量, "p_value": p值}

---

#### 函数: `cohens_d()`
**位置**: 第69-78行

**目的**: 计算 Cohen's d 效应量

**公式**:
```
d = (μ1 - μ2) / σ_pooled
```

**含义**:
- |d| < 0.2 → 效应小
- 0.2 ≤ |d| < 0.8 → 效应中等
- |d| ≥ 0.8 → 效应大

---

## 证据1: 任务间置信度对比

### 核心指标
- **平均置信度**: 每个任务的平均 Top-1 概率
- **置信度分布**: 置信度的直方图

### 分析方法
1. 计算每个任务的平均置信度
2. 使用 KS 检验比较任务间的置信度分布
3. 计算 Cohen's d 效应量

### 预期结果
- 不同任务的置信度可能有差异
- 某些任务(如数学推理)可能有更高的置信度

---

## 证据2: 多层置信度一致性

### 核心指标
- **一致性比例**: 所有层选择相同 Top-1 专家的 token 比例
- **平均一致层数**: 平均有多少层选择相同专家

### 分析方法
1. 对每个 token,检查所有层的 Top-1 是否相同
2. 计算一致性比例
3. 分析一致性与置信度的关系

### 预期结果
- 高置信度 token 可能有更高的多层一致性
- 说明模型在确定的情况下,多层倾向选择相同专家

---

## 证据3: 置信度 vs 切换率关联

### 核心指标
- **切换率**: 相邻 token 切换 Top-1 专家的比例
- **置信度-切换率相关性**: 两者的相关系数

### 分析方法
1. 将 token 按置信度分组(高/中/低)
2. 计算每组的切换率
3. 分析相关性

### 预期结果
- 高置信度可能对应低切换率
- 说明模型在确定时更倾向保持专家选择

---

## 证据4: 序列位置 vs 置信度

### 核心指标
- **位置-置信度曲线**: 置信度随序列位置的变化

### 分析方法
1. 将序列划分为多个位置区间
2. 计算每个区间的平均置信度
3. 绘制曲线

### 预期结果
- 置信度可能在序列前部较低,后部较高
- 或者保持稳定

---

## 证据5: 低置信度 token 特征

### 核心指标
- **低置信度 token 的特征**: 词性、长度、熵等

### 分析方法
1. 筛选低置信度 token(如置信度 < 0.5)
2. 分析其特征分布
3. 与高置信度 token 对比

### 预期结果
- 低置信度 token 可能是:
  - 罕见词
  - 多义词
  - 语义模糊的词

---

## 实验结论

### 结论1: 任务间置信度有差异
**观察**: 不同任务的平均置信度不同

**解释**: 某些任务(如数学推理)可能需要更确定的专家选择

---

### 结论2: 高置信度对应高一致性
**观察**: 高置信度 token 的多层一致性更高

**解释**: 模型在确定时,多层倾向选择相同专家

---

### 结论3: 置信度与切换率负相关
**观察**: 高置信度对应低切换率

**解释**: 模型在确定时更倾向保持专家选择

---

## 与其他问题的关联

### Q3: 任务内路由模式
- Q3 发现高切换率(无粘滞性)
- Q5 发现置信度与切换率负相关
- **结合**: 虽然整体切换率高,但高置信度时切换率较低

### Q4: 长上下文位置漂移
- Q4 发现无位置漂移
- Q5 分析置信度是否随位置变化
- **结合**: 置信度可能在不同位置保持稳定

---

## 代码运行示例

```bash
python analyze_q5_full.py \
    --task gsm8k=/path/to/gsm8k \
    --task piqa=/path/to/piqa \
    --output_dir ./output_q5 \
    --layer 0 \
    --seed 42
```

**输出文件**:
- `q5_full_results.json`: 完整分析结果
- `plots/`: 所有图表

---

**文档创建时间**: 2026-01-19
**作者**: Claude (基于李康锐的原始代码)
