#!/usr/bin/env python3
# -*- coding: utf-8 -*-
# ============================================================================
# Q5 路由置信度特征分析脚本 - 详细注释补充（第3部分）
# 样本级特征聚合
# ============================================================================

"""
========================================================================
本部分包含 Q5 的核心函数：
1. aggregate_sample_features：将 token 级特征聚合为样本级特征
========================================================================
"""

# ============================================================================
# 核心函数：aggregate_sample_features（样本级特征聚合）
# ============================================================================
def aggregate_sample_features(token_features: Dict[str, np.ndarray]) -> Dict[str, float]:
    """
    ========================================================================
    函数功能：将 token 级特征聚合为样本级特征
    ========================================================================

    【什么是样本级特征？】
    一个样本（例如一道题）包含多个 token，每个 token 有自己的置信度特征。
    样本级特征就是把所有 token 的特征"汇总"成一个数字。

    【给零基础同学的解释】：
    想象你要评估一个班级的整体表现：
    - Token 级特征：每个学生的成绩（个体数据）
    - 样本级特征：班级的平均分、标准差、最高分等（汇总数据）

    【为什么需要样本级特征？】
    1. 预测任务难度：整个样本的平均置信度
    2. 预测答对/答错：置信度低的样本更可能答错
    3. 任务间对比：不同任务的平均置信度差异

    【聚合的7个特征】：

    **1. top1_prob_mean（Top-1 概率均值）**：
    - 含义：所有 token 的平均 Top-1 概率
    - 解释：样本整体的"路由自信度"
    - 示例：0.7 表示平均每个 token 的 Top-1 概率是 70%

    **2. top1_prob_std（Top-1 概率标准差）**：
    - 含义：Top-1 概率的波动程度
    - 解释：样本内部的"置信度一致性"
    - 示例：0.1 表示大部分 token 的 Top-1 概率接近均值

    **3. margin_mean（Margin 均值）**：
    - 含义：所有 token 的平均 Margin
    - 解释：样本整体的"选择明确性"
    - 示例：0.5 表示平均 Top-1 和 Top-2 差距 50%

    **4. margin_std（Margin 标准差）**：
    - 含义：Margin 的波动程度
    - 解释：样本内部的"选择一致性"

    **5. entropy_mean（熵均值）**：
    - 含义：所有 token 的平均归一化熵
    - 解释：样本整体的"路由不确定性"
    - 示例：0.3 表示平均每个 token 的熵是 30%

    **6. entropy_max（最大熵）**：
    - 含义：所有 token 中最大的熵
    - 解释：样本中"最犹豫的 token"
    - 示例：0.9 表示有个 token 非常犹豫

    **7. low_conf_ratio（低置信度比例）**：
    - 含义：Top-1 概率 < 0.2 的 token 占比
    - 解释：样本中"不自信的 token"比例
    - 示例：0.15 表示 15% 的 token 置信度很低

    【示例】：
    假设一个样本有 5 个 token：

    Token 0：top1=0.8, margin=0.7, entropy=0.3
    Token 1：top1=0.7, margin=0.5, entropy=0.4
    Token 2：top1=0.6, margin=0.4, entropy=0.5
    Token 3：top1=0.5, margin=0.3, entropy=0.6
    Token 4：top1=0.15, margin=0.05, entropy=0.9（低置信度）

    【聚合结果】：
    - top1_prob_mean = (0.8+0.7+0.6+0.5+0.15)/5 = 0.55
    - top1_prob_std = std([0.8, 0.7, 0.6, 0.5, 0.15]) ≈ 0.24
    - margin_mean = (0.7+0.5+0.4+0.3+0.05)/5 = 0.39
    - margin_std = std([0.7, 0.5, 0.4, 0.3, 0.05]) ≈ 0.24
    - entropy_mean = (0.3+0.4+0.5+0.6+0.9)/5 = 0.54
    - entropy_max = 0.9（Token 4 最犹豫）
    - low_conf_ratio = 1/5 = 0.2（20% 的 token 低置信度）

    【给零基础同学的解释】：
    想象你要评估一个班级的考试表现：
    - 平均分：班级整体水平
    - 标准差：成绩是否稳定
    - 最高分：最好的学生
    - 不及格率：有多少学生没考好

    【参数说明】：
    - token_features: Dict[str, np.ndarray]
      * "top1_prob": shape (n_tokens,)
      * "margin": shape (n_tokens,)
      * "entropy": shape (n_tokens,)

    【返回值】：
    - Dict[str, float]，包含7个样本级特征
    """
    # ====================================================================
    # 步骤1：提取 token 级特征
    # ====================================================================
    """
    【提取特征】：
    top1 = token_features["top1_prob"]
    margin = token_features["margin"]
    ent = token_features["entropy"]

    【示例】：
    top1 = array([0.8, 0.7, 0.6, 0.5, 0.15])
    margin = array([0.7, 0.5, 0.4, 0.3, 0.05])
    ent = array([0.3, 0.4, 0.5, 0.6, 0.9])

    【给零基础同学的解释】：
    想象你要从表格中提取每个学生的成绩：
    - top1：每个学生的最高分
    - margin：每个学生的第一名和第二名差距
    - ent：每个学生的犹豫程度
    """
    top1 = token_features["top1_prob"]
    margin = token_features["margin"]
    ent = token_features["entropy"]

    # ====================================================================
    # 步骤2：计算均值和标准差
    # ====================================================================
    """
    【计算统计量】：
    np.mean(top1)：计算平均值
    np.std(top1)：计算标准差
    np.max(ent)：计算最大值

    【标准差的含义】：
    标准差衡量"数据的波动程度"：
    - 标准差小：数据集中在均值附近
    - 标准差大：数据分散

    【示例】：
    top1 = [0.8, 0.7, 0.6, 0.5, 0.15]

    均值：
    mean = (0.8+0.7+0.6+0.5+0.15)/5 = 0.55

    标准差：
    1. 计算每个值与均值的差：
       [0.8-0.55, 0.7-0.55, 0.6-0.55, 0.5-0.55, 0.15-0.55]
       = [0.25, 0.15, 0.05, -0.05, -0.4]

    2. 平方：
       [0.0625, 0.0225, 0.0025, 0.0025, 0.16]

    3. 求平均：
       (0.0625+0.0225+0.0025+0.0025+0.16)/5 = 0.05

    4. 开方：
       std = sqrt(0.05) ≈ 0.224

    【给零基础同学的解释】：
    想象你要统计班级成绩：
    - 平均分：80分（整体水平）
    - 标准差：10分（成绩波动）
      * 标准差小（5分）：大家成绩接近
      * 标准差大（20分）：成绩差距大
    """
    # 计算 Top-1 概率的统计量
    top1_mean = float(np.mean(top1))
    top1_std = float(np.std(top1))

    # 计算 Margin 的统计量
    margin_mean = float(np.mean(margin))
    margin_std = float(np.std(margin))

    # 计算熵的统计量
    entropy_mean = float(np.mean(ent))
    entropy_max = float(np.max(ent))
    entropy_std = float(np.std(ent))

    # ====================================================================
    # 步骤3：计算低置信度比例
    # ====================================================================
    """
    【低置信度比例】：
    low_conf_ratio = float(np.mean(top1 < 0.2))

    【逐步拆解】：
    1. top1 < 0.2：布尔数组（True/False）
       例如：[False, False, False, False, True]
       （只有最后一个 token 的 Top-1 < 0.2）

    2. np.mean(...)：计算 True 的比例
       例如：1/5 = 0.2（20%）

    【为什么阈值是 0.2？】
    因为 0.2 是一个经验阈值：
    - Top-1 < 0.2：路由非常不自信
    - 如果有很多这样的 token，说明样本可能很难

    【示例】：
    top1 = [0.8, 0.7, 0.6, 0.5, 0.15]

    步骤1：判断每个值是否 < 0.2
    top1 < 0.2 = [False, False, False, False, True]

    步骤2：计算 True 的比例
    np.mean([False, False, False, False, True])
    = np.mean([0, 0, 0, 0, 1])
    = 1/5 = 0.2

    【给零基础同学的解释】：
    想象你要统计"不及格率"：
    - 班级有5个学生
    - 成绩：[80, 70, 60, 50, 15]
    - 不及格线：20分
    - 不及格人数：1人
    - 不及格率：1/5 = 20%
    """
    low_conf_ratio = float(np.mean(top1 < 0.2))

    # ====================================================================
    # 步骤4：返回样本级特征字典
    # ====================================================================
    """
    【返回结果】：
    return {
        "top1_prob_mean": ...,
        "top1_prob_std": ...,
        "margin_mean": ...,
        "margin_std": ...,
        "entropy_mean": ...,
        "entropy_max": ...,
        "entropy_std": ...,
        "low_conf_ratio": ...,
        "n_tokens": ...,
    }

    【返回值格式】：
    字典，包含9个键值对（8个特征 + token 数量）。

    【示例】：
    {
        "top1_prob_mean": 0.55,
        "top1_prob_std": 0.224,
        "margin_mean": 0.39,
        "margin_std": 0.24,
        "entropy_mean": 0.54,
        "entropy_max": 0.9,
        "entropy_std": 0.21,
        "low_conf_ratio": 0.2,
        "n_tokens": 5,
    }

    【给零基础同学的解释】：
    想象你要整理班级的统计报告：
    - 平均分：55分
    - 标准差：22.4分
    - 最高分：90分
    - 不及格率：20%
    - 学生人数：5人
    """
    return {
        "top1_prob_mean": top1_mean,
        "top1_prob_std": top1_std,
        "margin_mean": margin_mean,
        "margin_std": margin_std,
        "entropy_mean": entropy_mean,
        "entropy_max": entropy_max,
        "entropy_std": entropy_std,
        "low_conf_ratio": low_conf_ratio,
        "n_tokens": len(top1),
    }


# ============================================================================
# Q5 Part 3 完成
# ============================================================================
# 已完成的内容：
# - Part 1: 熵和归一化熵的数学函数
# - Part 2: Token 级置信度特征提取（Top-1 概率、Margin、熵）
# - Part 3: 样本级特征聚合（均值、标准差、最大值、低置信度比例）
#
# Q5 的核心特征提取部分已经完成！
# 如果需要继续补充 AUC、ROC 曲线、校准曲线等内容，可以创建 Part 4。
# ============================================================================
